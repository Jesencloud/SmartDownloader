<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿›åº¦æ¡å¹³æ»‘æ˜¾ç¤ºæµ‹è¯•</title>
    <style>
        .progress-container {
            width: 400px;
            margin: 20px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        
        .progress-bar-container {
            width: 100%;
            background-color: #f0f0f0;
            border-radius: 4px;
            height: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #6a5acd, #4169e1, #6a5acd);
            border-radius: 4px;
            transition: width 0.1s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        button {
            margin: 10px 5px;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="progress-container">
        <h3>è¿›åº¦æ¡å¹³æ»‘æ˜¾ç¤ºæµ‹è¯•</h3>
        <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar" style="width: 0%">
                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-20 animate-pulse"></div>
            </div>
            <div class="progress-text" id="progressText">0%</div>
        </div>
        
        <div>
            <button onclick="testSmallIncrement()">å°å¹…å¢é•¿ (+5%)</button>
            <button onclick="testLargeJump()">å¤§å¹…è·³è·ƒ (+25%)</button>
            <button onclick="testWithETA()">æ¨¡æ‹ŸETAå¹³æ»‘</button>
            <button onclick="resetProgress()">é‡ç½®</button>
        </div>
        
        <div id="logs" style="margin-top: 20px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px;"></div>
    </div>

    <script>
        // ç®€åŒ–ç‰ˆçš„å¹³æ»‘è¿›åº¦ç®¡ç†å™¨ï¼Œç”¨äºæµ‹è¯•
        class SmoothProgressManager {
            constructor() {
                this.currentAnimation = null;
            }
            
            startSmoothProgress(currentProgress, targetProgress, etaSeconds = 0) {
                if (this.currentAnimation) {
                    clearInterval(this.currentAnimation);
                }
                
                // ç¡®ä¿è¿›åº¦æ•°å€¼åˆç†
                currentProgress = Math.max(0, Math.min(100, currentProgress));
                targetProgress = Math.max(0, Math.min(100, targetProgress));
                
                this.log(`å¼€å§‹å¹³æ»‘åŠ¨ç”»: ${currentProgress}% â†’ ${targetProgress}%`);
                
                // å¦‚æœè¿›åº¦å·®è·å¾ˆå°ï¼Œç›´æ¥æ›´æ–°
                if (Math.abs(targetProgress - currentProgress) < 0.5) {
                    this.updateProgressBar(targetProgress);
                    return;
                }
                
                // å¦‚æœç›®æ ‡è¿›åº¦å°äºå½“å‰è¿›åº¦ï¼Œç›´æ¥æ›´æ–°ï¼ˆé¿å…è¿›åº¦å€’é€€ï¼‰
                if (targetProgress < currentProgress) {
                    this.updateProgressBar(targetProgress);
                    return;
                }
                
                // è®¡ç®—åŠ¨ç”»å‚æ•°
                const progressDiff = targetProgress - currentProgress;
                
                // ä¼˜åŒ–åŠ¨ç”»æ—¶é•¿è®¡ç®—
                let animationDuration;
                if (etaSeconds > 0 && etaSeconds < 60) {
                    animationDuration = Math.min(etaSeconds * 800, 15000);
                } else {
                    animationDuration = Math.min(progressDiff * 100, 8000);
                }
                
                const updateInterval = 100;
                const totalSteps = Math.max(1, Math.floor(animationDuration / updateInterval));
                
                let stepCount = 0;
                
                this.currentAnimation = setInterval(() => {
                    stepCount++;
                    
                    // ä½¿ç”¨ç¼“åŠ¨å‡½æ•°
                    const easingFactor = this.easeOutQuart(stepCount / totalSteps);
                    const currentAnimatedProgress = currentProgress + (progressDiff * easingFactor);
                    
                    const displayProgress = Math.min(currentAnimatedProgress, targetProgress);
                    this.updateProgressBar(Math.round(displayProgress * 10) / 10);
                    
                    if (stepCount >= totalSteps || displayProgress >= targetProgress) {
                        clearInterval(this.currentAnimation);
                        this.currentAnimation = null;
                        this.updateProgressBar(targetProgress);
                        this.log(`âœ… åŠ¨ç”»å®Œæˆ: ${targetProgress}%`);
                    }
                }, updateInterval);
                
                this.log(`ğŸ¬ åŠ¨ç”»å‚æ•°: ${animationDuration}ms, ${totalSteps}æ­¥`);
            }
            
            easeOutQuart(t) {
                return 1 - Math.pow(1 - t, 4);
            }
            
            updateProgressBar(progress) {
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                
                progressBar.style.width = progress + '%';
                progressText.textContent = progress + '%';
            }
            
            log(message) {
                const logs = document.getElementById('logs');
                const timestamp = new Date().toLocaleTimeString();
                logs.innerHTML += `[${timestamp}] ${message}<br>`;
                logs.scrollTop = logs.scrollHeight;
            }
            
            getCurrentProgress() {
                const progressBar = document.getElementById('progressBar');
                return parseFloat(progressBar.style.width) || 0;
            }
        }
        
        const smoothProgressManager = new SmoothProgressManager();
        
        function testSmallIncrement() {
            const current = smoothProgressManager.getCurrentProgress();
            const target = Math.min(100, current + 5);
            smoothProgressManager.startSmoothProgress(current, target);
        }
        
        function testLargeJump() {
            const current = smoothProgressManager.getCurrentProgress();
            const target = Math.min(100, current + 25);
            smoothProgressManager.startSmoothProgress(current, target);
        }
        
        function testWithETA() {
            const current = smoothProgressManager.getCurrentProgress();
            const target = Math.min(100, current + 15);
            const eta = 8; // 8ç§’ETA
            smoothProgressManager.startSmoothProgress(current, target, eta);
        }
        
        function resetProgress() {
            if (smoothProgressManager.currentAnimation) {
                clearInterval(smoothProgressManager.currentAnimation);
                smoothProgressManager.currentAnimation = null;
            }
            smoothProgressManager.updateProgressBar(0);
            document.getElementById('logs').innerHTML = '';
            smoothProgressManager.log('è¿›åº¦æ¡å·²é‡ç½®');
        }
    </script>
</body>
</html>
<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Download Video - Smart Downloader</title>
    <meta name="keywords" content="æ™ºèƒ½ä¸‹è½½å™¨, è§†é¢‘ä¸‹è½½, éŸ³é¢‘ä¸‹è½½, æ’­æ”¾åˆ—è¡¨ä¸‹è½½" />
    <meta name="description" content="é€‰æ‹©æ‚¨éœ€è¦çš„è§†é¢‘åˆ†è¾¨ç‡å¹¶ä¸‹è½½" />

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ç»§æ‰¿ä¸»é¡µé¢çš„æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Helvetica, Apple Color Emoji, Arial, sans-serif, Segoe UI Emoji, Segoe UI Symbol;
            transition: background-color 0.3s ease, color 0.3s ease;
            background-color: #f3f4f6;
            color: #000000;
        }

        /* Dark mode styles */
        body.dark-mode {
            background-color: #1a1a1a !important;
            color: #ffffff !important;
        }

        body.dark-mode header {
            background-color: #2d2d2d;
            border-bottom: 1px solid #404040;
        }

        body.dark-mode .logo a {
            color: #ffffff;
        }

        body.dark-mode .header-right a {
            color: #ffffff;
        }

        body.dark-mode .download-container {
            background-color: #2d2d2d;
            border: 1px solid #404040;
        }

        body.dark-mode .resolution-option {
            background-color: #374151;
            border-color: #4b5563;
            color: #ffffff;
        }

        body.dark-mode .resolution-option:hover {
            background-color: #4b5563;
            border-color: #6b7280;
        }

        body.dark-mode .resolution-option.selected {
            background-color: #1e3a8a;
            border-color: #3b82f6;
        }

        /* Dark mode toggle button */
        .dark-mode-toggle {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            margin-left: 15px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .dark-mode-toggle:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .dark-mode-toggle:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        header {
            background-color: #f3f4f6;
            border-bottom: 1px solid #e5e7eb;
        }

        .logo a {
            text-decoration: none;
            color: #1e40af;
            font-size: 24px;
            font-weight: bold;
        }

        .header-right {
            display: flex;
            align-items: center;
        }

        .header-right a {
            margin-left: 15px;
            text-decoration: none;
            color: #374151;
            font-size: 14px;
        }

        .download-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .page-title {
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 1rem;
        }

        .video-info {
            background: #f8faff;
            border: 1px solid #e0e7ff;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .video-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .video-url {
            font-size: 0.875rem;
            color: #6b7280;
            word-break: break-all;
        }

        .resolution-section {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
        }

        .resolution-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .col-span-full {
            grid-column: 1 / -1;
        }

        .resolution-option {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
            text-align: center;
        }

        .resolution-option:hover {
            border-color: #3b82f6;
            background-color: #f8faff;
        }

        .resolution-option.selected {
            border-color: #3b82f6;
            background-color: #dbeafe;
        }

        .resolution-label {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .resolution-details {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0099ff 0%, #2392d6 100%);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 153, 255, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .loading-state {
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
        }

        /* Dark mode adjustments */
        body.dark-mode .page-title {
            color: #ffffff;
        }

        body.dark-mode .video-info {
            background-color: #374151;
            border-color: #4b5563;
        }

        body.dark-mode .video-title {
            color: #ffffff;
        }

        body.dark-mode .video-url {
            color: #d1d5db;
        }

        body.dark-mode .section-title {
            color: #ffffff;
        }

        body.dark-mode .resolution-label {
            color: #ffffff;
        }

        body.dark-mode .resolution-details {
            color: #d1d5db;
        }

        body.dark-mode .error-message {
            background-color: #4a2a2a;
            border-color: #663333;
            color: #f87171;
        }
    </style>
</head>

<body>
    <!-- Header Start -->
    <header class="bg-gray-100 border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-3">
                <div class="logo">
                    <a href="/" class="text-blue-600 font-bold text-2xl">Smart Downloader</a>
                </div>
                <div class="header-right flex items-center">
                    <a href="/" class="text-gray-700 hover:text-blue-600 transition-colors mr-4">è¿”å›ä¸»é¡µ</a>
                    <button id="darkModeToggle" class="dark-mode-toggle p-2 rounded-lg hover:bg-gray-200 transition-colors">ğŸŒ™</button>
                </div>
            </div>
        </div>
    </header>
    <!-- Header End -->

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="download-container">
            <h1 class="page-title">Download Video</h1>
            
            <!-- Loading State -->
            <div id="loadingState" class="loading-state">
                <div class="spinner"></div>
                <p>æ­£åœ¨è·å–è§†é¢‘ä¿¡æ¯...</p>
            </div>

            <!-- Error State -->
            <div id="errorState" style="display: none;">
                <div class="error-message">
                    <p id="errorMessage">è·å–è§†é¢‘ä¿¡æ¯å¤±è´¥</p>
                </div>
                <div class="action-buttons">
                    <a href="/" class="btn btn-secondary">è¿”å›ä¸»é¡µ</a>
                </div>
            </div>

            <!-- Main Content -->
            <div id="mainContent" style="display: none;">
                <!-- Video Info -->
                <div class="video-info">
                    <div class="video-title" id="videoTitle">è§†é¢‘æ ‡é¢˜</div>
                    <div class="video-url" id="videoUrl">è§†é¢‘é“¾æ¥</div>
                </div>

                <!-- Resolution Selection -->
                <div class="resolution-section">
                    <h2 class="section-title">é€‰æ‹©åˆ†è¾¨ç‡</h2>
                    <div class="resolution-grid" id="resolutionGrid">
                        <!-- åˆ†è¾¨ç‡é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <a href="/" class="btn btn-secondary">è¿”å›ä¸»é¡µ</a>
                    <button id="downloadButton" class="btn btn-primary" disabled>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4m4-5l5 5 5-5m-5 5V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        ä¸‹è½½é€‰ä¸­æ ¼å¼
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode functionality
        function initializeDarkMode() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const body = document.body;
            
            if (!darkModeToggle) {
                console.error('Dark mode toggle button not found!');
                return;
            }
            
            // Check for saved theme preference or default to light mode
            const currentTheme = localStorage.getItem('theme') || 'light';
            
            if (currentTheme === 'dark') {
                body.classList.add('dark-mode');
                darkModeToggle.textContent = 'â˜€ï¸';
            } else {
                darkModeToggle.textContent = 'ğŸŒ™';
            }
            
            // Toggle dark mode
            darkModeToggle.addEventListener('click', () => {
                body.classList.toggle('dark-mode');
                
                if (body.classList.contains('dark-mode')) {
                    darkModeToggle.textContent = 'â˜€ï¸';
                    localStorage.setItem('theme', 'dark');
                } else {
                    darkModeToggle.textContent = 'ğŸŒ™';
                    localStorage.setItem('theme', 'light');
                }
            });
        }

        // å…¨å±€å˜é‡
        let selectedResolution = null;
        let selectedFormatId = null;
        let videoData = null;

        // å®‰å…¨çš„æ–‡ä»¶åæ¸…ç†å‡½æ•°
        function sanitizeFilename(filename) {
            if (!filename) return 'untitled';
            
            // ç§»é™¤æˆ–æ›¿æ¢å±é™©å­—ç¬¦
            const cleaned = filename
                .replace(/[<>:"/\\|?*\x00-\x1F\x7F-\x9F]/g, '_')  // æ›¿æ¢éæ³•å­—ç¬¦
                .replace(/^\./g, '_')                              // ä¸èƒ½ä»¥ç‚¹å¼€å¤´
                .replace(/\s+/g, '_')                             // æ›¿æ¢ç©ºæ ¼ä¸ºä¸‹åˆ’çº¿
                .replace(/_{2,}/g, '_')                           // åˆå¹¶å¤šä¸ªä¸‹åˆ’çº¿
                .replace(/^_+|_+$/g, '')                          // ç§»é™¤å¼€å¤´å’Œç»“å°¾çš„ä¸‹åˆ’çº¿
                .substring(0, 200);                               // é™åˆ¶é•¿åº¦
            
            // ç¡®ä¿æ–‡ä»¶åä¸ä¸ºç©º
            return cleaned || 'untitled';
        }

        // ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶å
        function generateSafeFilename(title, resolution, type) {
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const extension = type === 'video' ? 'mp4' : 'mp3';
            const cleanTitle = sanitizeFilename(title);
            const cleanResolution = sanitizeFilename(resolution);
            
            return `${cleanTitle}_${cleanResolution}_${timestamp}.${extension}`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize dark mode
            initializeDarkMode();
            
            // è·å–URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const videoUrl = urlParams.get('url');
            const downloadType = urlParams.get('type') || 'video';
            
            if (!videoUrl) {
                showError('ç¼ºå°‘è§†é¢‘URLå‚æ•°');
                return;
            }
            
            // æ˜¾ç¤ºè§†é¢‘URL
            document.getElementById('videoUrl').textContent = videoUrl;
            
            // è·å–çœŸå®çš„è§†é¢‘ä¿¡æ¯
            fetchVideoInfo(videoUrl, downloadType);
            
            // ä¸‹è½½æŒ‰é’®äº‹ä»¶
            document.getElementById('downloadButton').addEventListener('click', () => {
                if (selectedFormatId) {
                    startDownload();
                }
            });
        });

        async function fetchVideoInfo(url, type) {
            try {
                const response = await fetch('/video-info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'è·å–è§†é¢‘ä¿¡æ¯å¤±è´¥');
                }

                const videoInfo = await response.json();
                videoData = videoInfo;
                
                // æ›´æ–°é¡µé¢æ ‡é¢˜
                document.querySelector('.page-title').textContent = type === 'video' ? 'Download Video' : 'Download Audio';
                
                // æ˜¾ç¤ºè§†é¢‘ä¿¡æ¯
                document.getElementById('videoTitle').textContent = videoInfo.title;
                
                // ç”Ÿæˆåˆ†è¾¨ç‡é€‰é¡¹
                generateResolutionOptions(videoInfo.formats, type);
                
                // éšè—åŠ è½½çŠ¶æ€ï¼Œæ˜¾ç¤ºä¸»å†…å®¹
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
            } catch (error) {
                console.error('è·å–è§†é¢‘ä¿¡æ¯å¤±è´¥:', error);
                showError('è·å–è§†é¢‘ä¿¡æ¯å¤±è´¥: ' + error.message);
            }
        }

        function generateResolutionOptions(formats, type) {
            const resolutionGrid = document.getElementById('resolutionGrid');
            resolutionGrid.innerHTML = '';
            
            if (formats.length === 0) {
                resolutionGrid.innerHTML = `
                    <div class="col-span-full text-center p-6">
                        <p class="text-gray-500 text-lg mb-2">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„${type === 'video' ? 'è§†é¢‘' : 'éŸ³é¢‘'}æ ¼å¼</p>
                        <p class="text-gray-400 text-sm">æˆ‘ä»¬åªæ˜¾ç¤ºæœ‰æ˜ç¡®æ–‡ä»¶å¤§å°çš„MP4æ ¼å¼è§†é¢‘</p>
                    </div>
                `;
                return;
            }
            
            formats.forEach(format => {
                const optionElement = document.createElement('div');
                optionElement.className = 'resolution-option';
                optionElement.dataset.formatId = format.format_id;
                optionElement.dataset.resolution = format.resolution;
                
                // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
                const sizeText = formatFileSize(format.filesize);
                
                // æ„å»ºæ ¼å¼æè¿°
                const codecInfo = format.vcodec ? ` (${format.vcodec})` : '';
                const fpsInfo = format.fps ? ` ${format.fps}fps` : '';
                
                // ä¸ºéMP4æ ¼å¼æ·»åŠ æ ‡è¯†
                const formatLabel = format.ext.toUpperCase() + (format.ext !== 'mp4' ? ' âš ï¸' : '');
                
                optionElement.innerHTML = `
                    <div class="resolution-label">${format.resolution}</div>
                    <div class="resolution-details">${formatLabel}${codecInfo}${fpsInfo}</div>
                    <div class="resolution-details">${sizeText}</div>
                `;
                
                optionElement.addEventListener('click', () => selectResolution(format.format_id, format.resolution));
                resolutionGrid.appendChild(optionElement);
            });
        }

        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return 'æœªçŸ¥å¤§å°';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function selectResolution(formatId, resolution) {
            // ç§»é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll('.resolution-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // é€‰æ‹©å½“å‰é€‰é¡¹
            const selectedOption = document.querySelector(`[data-format-id="${formatId}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
                selectedFormatId = formatId;
                selectedResolution = resolution;
                document.getElementById('downloadButton').disabled = false;
            }
        }

        function startDownload() {
            const downloadButton = document.getElementById('downloadButton');
            downloadButton.disabled = true;
            downloadButton.innerHTML = `
                <div class="spinner" style="width: 20px; height: 20px; margin-right: 0.5rem;"></div>
                æ­£åœ¨å‡†å¤‡ä¸‹è½½...
            `;
            
            // è·å–URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const videoUrl = urlParams.get('url');
            const downloadType = urlParams.get('type') || 'video';
            
            // è§¦å‘æ–‡ä»¶ä¿å­˜å¯¹è¯æ¡†
            setTimeout(() => {
                triggerFileDownload(videoUrl, downloadType, selectedFormatId, selectedResolution);
            }, 1000);
        }

        function triggerFileDownload(url, type, formatId, resolution) {
            // æ£€æŸ¥æ˜¯å¦æ”¯æŒ showSaveFilePicker API (ç°ä»£æµè§ˆå™¨)
            if ('showSaveFilePicker' in window) {
                triggerModernFileSave(url, type, formatId, resolution);
            } else {
                // å›é€€åˆ°ä¼ ç»Ÿä¸‹è½½æ–¹å¼
                triggerTraditionalDownload(url, type, formatId, resolution);
            }
        }

        async function triggerModernFileSave(url, type, formatId, resolution) {
            try {
                const filename = generateSafeFilename(videoData.title, resolution, type);
                
                // ä½¿ç”¨ç°ä»£æ–‡ä»¶ç³»ç»Ÿè®¿é—®APIæ˜¾ç¤ºä¿å­˜å¯¹è¯æ¡†
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: filename,
                    types: [{
                        description: type === 'video' ? 'Video files' : 'Audio files',
                        accept: type === 'video' ? { 'video/mp4': ['.mp4'] } : { 'audio/mp3': ['.mp3'] }
                    }]
                });

                // è¿™é‡Œåº”è¯¥è°ƒç”¨å®é™…çš„ä¸‹è½½API
                // æ¨¡æ‹Ÿæ–‡ä»¶æ•°æ®ï¼ˆå®é™…åº”ç”¨ä¸­è¿™é‡Œä¼šæ˜¯çœŸå®çš„æ–‡ä»¶å†…å®¹ï¼‰
                const blob = new Blob([`æ¨¡æ‹Ÿä¸‹è½½å†…å®¹ - Format ID: ${formatId}`], { 
                    type: type === 'video' ? 'video/mp4' : 'audio/mp3' 
                });
                
                const writable = await fileHandle.createWritable();
                await writable.write(blob);
                await writable.close();
                
                alert('æ–‡ä»¶ä¿å­˜æˆåŠŸï¼');
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('ä¿å­˜æ–‡ä»¶æ—¶å‡ºé”™:', error);
                    alert('ä¿å­˜æ–‡ä»¶å¤±è´¥: ' + error.message);
                }
                // å¦‚æœç”¨æˆ·å–æ¶ˆäº†å¯¹è¯æ¡†ï¼Œå›é€€åˆ°ä¼ ç»Ÿä¸‹è½½
                triggerTraditionalDownload(url, type, formatId, resolution);
            } finally {
                resetDownloadButton();
            }
        }

        function triggerTraditionalDownload(url, type, formatId, resolution) {
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„aæ ‡ç­¾æ¥è§¦å‘æ–‡ä»¶ä¸‹è½½
            const link = document.createElement('a');
            
            const filename = generateSafeFilename(videoData.title, resolution, type);
            
            // è¿™é‡Œåº”è¯¥è°ƒç”¨å®é™…çš„ä¸‹è½½API
            // æ¨¡æ‹Ÿæ–‡ä»¶æ•°æ®ï¼ˆå®é™…åº”ç”¨ä¸­è¿™é‡Œä¼šæ˜¯çœŸå®çš„æ–‡ä»¶å†…å®¹ï¼‰
            const blob = new Blob([`æ¨¡æ‹Ÿä¸‹è½½å†…å®¹ - Format ID: ${formatId}`], { 
                type: type === 'video' ? 'video/mp4' : 'audio/mp3' 
            });
            const objectUrl = URL.createObjectURL(blob);
            
            link.href = objectUrl;
            link.download = filename;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // æ¸…ç†URLå¯¹è±¡
            URL.revokeObjectURL(objectUrl);
            
            resetDownloadButton();
            alert('æ–‡ä»¶ä¸‹è½½å·²å¼€å§‹ï¼è¯·æ£€æŸ¥æ‚¨çš„ä¸‹è½½æ–‡ä»¶å¤¹ã€‚');
        }

        function resetDownloadButton() {
            const downloadButton = document.getElementById('downloadButton');
            downloadButton.disabled = false;
            downloadButton.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4m4-5l5 5 5-5m-5 5V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                ä¸‹è½½é€‰ä¸­æ ¼å¼
            `;
        }

        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').style.display = 'block';
        }
    </script>
</body>
</html>
# ä¸´æ—¶æ–‡ä»¶ç®¡ç†æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›SmartDownloaderä¸´æ—¶æ–‡ä»¶ç®¡ç†çš„å®Œæ•´æŒ‡å—ï¼ŒåŒ…æ‹¬ç›‘æ§ã€æ¸…ç†å’Œä¼˜åŒ–ç­–ç•¥ã€‚

## ğŸ—ï¸ æ¶æ„è¯´æ˜

### ä¸´æ—¶æ–‡ä»¶ä½¿ç”¨åœºæ™¯

SmartDownloaderåœ¨ä»¥ä¸‹æƒ…å†µä¸‹ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ï¼š

1. **å…ƒæ•°æ®åµŒå…¥ä¸‹è½½**ï¼šä¸ºäº†æ”¯æŒè§†é¢‘æ–‡ä»¶å…ƒæ•°æ®åµŒå…¥ï¼ˆç®€åŒ–æ¥æºä¿¡æ¯ï¼‰ï¼Œéœ€è¦å…ˆä¸‹è½½åˆ°ä¸´æ—¶æ–‡ä»¶
2. **æµå¼ä¼ è¾“ä¼˜åŒ–**ï¼šä¸‹è½½å®Œæˆåé€šè¿‡64KBç¼“å†²åŒºé«˜æ•ˆæµå¼ä¼ è¾“ç»™å®¢æˆ·ç«¯
3. **ç½‘ç»œé‡è¯•æœºåˆ¶**ï¼šæ”¯æŒSSLé”™è¯¯ç­‰ç½‘ç»œé—®é¢˜çš„è‡ªåŠ¨é‡è¯•

### æŠ€æœ¯å®ç°

```python
# ä¸´æ—¶æ–‡ä»¶åˆ›å»º
with tempfile.NamedTemporaryFile(suffix=f".{file_extension}", delete=False) as temp_file:
    temp_path = temp_file.name

# å…ƒæ•°æ®åµŒå…¥å‘½ä»¤
cmd = command_builder.build_streaming_download_cmd(temp_path, url, format_id)

# é«˜æ•ˆæµå¼ä¼ è¾“
chunk_size = 65536  # 64KB chunks
async with aiofiles.open(temp_path, 'rb') as f:
    while True:
        chunk = await f.read(chunk_size)
        if not chunk:
            break
        yield chunk
```

## ğŸ“Š ä¸´æ—¶æ–‡ä»¶ä½ç½®ä¸ç›‘æ§

### é»˜è®¤ä½ç½®
- **macOS**: `/var/folders/r_/wft7gp413qz1yjh3fj58b4700000gn/T/`
- **Linux**: `/tmp/`
- **Windows**: `%TEMP%`

### å®æ—¶ç›‘æ§
ç³»ç»Ÿä¼šè‡ªåŠ¨ç›‘æ§ï¼š
- ä¸´æ—¶ç›®å½•å¯ç”¨ç©ºé—´
- å½“å¯ç”¨ç©ºé—´ < 1GBæ—¶å‘å‡ºè­¦å‘Š
- æ¯æ¬¡ä¸‹è½½æ˜¾ç¤ºä¸´æ—¶æ–‡ä»¶è·¯å¾„å’Œç³»ç»ŸçŠ¶æ€

## ğŸ› ï¸ ç®¡ç†å·¥å…·

### 1. ä¸´æ—¶æ–‡ä»¶ç®¡ç†å™¨ (`temp_file_manager.py`)

å®Œæ•´åŠŸèƒ½çš„Pythonç®¡ç†è„šæœ¬ï¼š

```bash
# æŸ¥çœ‹çŠ¶æ€
python3 scripts/temp_file_manager.py status

# é¢„è§ˆæ¸…ç†ï¼ˆå®‰å…¨æ¨¡å¼ï¼‰
python3 scripts/temp_file_manager.py clean --dry-run

# æ‰§è¡Œæ¸…ç†
python3 scripts/temp_file_manager.py clean --execute

# é«˜çº§é€‰é¡¹
python3 scripts/temp_file_manager.py clean --older-than 6 --execute --smartdownloader-only
```

### 2. ä¾¿æ·Shellå‘½ä»¤ (`temp_utils.sh`)

åŠ è½½åå¯ä½¿ç”¨ç®€åŒ–å‘½ä»¤ï¼š

```bash
# åŠ è½½ä¾¿æ·å‡½æ•°
source scripts/temp_utils.sh

# ä½¿ç”¨ä¾¿æ·å‘½ä»¤
temp-status                 # æŸ¥çœ‹çŠ¶æ€
temp-clean-preview         # é¢„è§ˆæ¸…ç†
temp-clean 2               # æ¸…ç†2å°æ—¶å‰æ–‡ä»¶
temp-clean-sd 0.5          # æ¸…ç†30åˆ†é’Ÿå‰SDæ–‡ä»¶
```

## ğŸ“ˆ åŠŸèƒ½ç‰¹æ€§

### ğŸ” ç›‘æ§åŠŸèƒ½

| åŠŸèƒ½ | æè¿° |
|------|------|
| **ç£ç›˜ç©ºé—´æ£€æŸ¥** | æ˜¾ç¤ºæ€»è®¡/å·²ç”¨/å¯ç”¨ç©ºé—´åŠç™¾åˆ†æ¯” |
| **æ–‡ä»¶åˆ†ç±»** | åŒºåˆ†SmartDownloader vs å…¶ä»–å·¥å…·æ–‡ä»¶ |
| **æ—¶é—´æ ‡è®°** | æ˜¾ç¤ºæ–‡ä»¶ä¿®æ”¹æ—¶é—´å’Œå¹´é¾„ |
| **å¤§å°ç»Ÿè®¡** | è‡ªåŠ¨æ ¼å¼åŒ–æ˜¾ç¤ºï¼ˆB/KB/MB/GBï¼‰ |

### ğŸ§¹ æ¸…ç†åŠŸèƒ½

| åŠŸèƒ½ | æè¿° |
|------|------|
| **å®‰å…¨é¢„è§ˆ** | é»˜è®¤dry-runæ¨¡å¼ï¼Œé¿å…è¯¯åˆ  |
| **æ—¶é—´è¿‡æ»¤** | å¯æŒ‡å®šæ¸…ç†å¤šå°‘å°æ—¶å‰çš„æ–‡ä»¶ |
| **é€‰æ‹©æ€§æ¸…ç†** | å¯åªæ¸…ç†SmartDownloaderæ–‡ä»¶ |
| **é”™è¯¯å¤„ç†** | è®°å½•æ¸…ç†å¤±è´¥çš„æ–‡ä»¶å’ŒåŸå›  |

### ğŸ”’ å®‰å…¨ç‰¹æ€§

- **é»˜è®¤é¢„è§ˆæ¨¡å¼**ï¼šä¸ä¼šæ„å¤–åˆ é™¤æ–‡ä»¶
- **æ—¶é—´ä¿æŠ¤**ï¼šåªæ¸…ç†æŒ‡å®šæ—¶é—´ä¹‹å‰çš„æ–‡ä»¶  
- **è¯¦ç»†æ—¥å¿—**ï¼šæ‰€æœ‰æ“ä½œéƒ½æœ‰å®Œæ•´è®°å½•
- **å¼‚å¸¸å¤„ç†**ï¼šç¡®ä¿ä¸´æ—¶æ–‡ä»¶åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½è¢«æ¸…ç†

## ğŸ¯ ä½¿ç”¨å»ºè®®

### æ—¥å¸¸ç»´æŠ¤

1. **å®šæœŸæ£€æŸ¥**ï¼ˆæ¨èæ¯æ—¥ï¼‰ï¼š
   ```bash
   temp-status
   ```

2. **é¢„é˜²æ€§æ¸…ç†**ï¼ˆæ¨èæ¯å°æ—¶ï¼‰ï¼š
   ```bash
   temp-clean-preview 1    # å…ˆé¢„è§ˆ
   temp-clean 1           # å†æ‰§è¡Œ
   ```

3. **ç£ç›˜ç©ºé—´ç´§å¼ æ—¶**ï¼š
   ```bash
   temp-clean 0.5         # æ¸…ç†30åˆ†é’Ÿå‰çš„æ–‡ä»¶
   ```

### è‡ªåŠ¨åŒ–è®¾ç½®

#### Cronå®šæ—¶ä»»åŠ¡ï¼ˆLinux/macOSï¼‰

```bash
# æ¯å°æ—¶æ¸…ç†1å°æ—¶å‰çš„ä¸´æ—¶æ–‡ä»¶
0 * * * * cd /path/to/SmartDownloader && python3 scripts/temp_file_manager.py clean --older-than 1 --execute --smartdownloader-only

# æ¯å¤©å‡Œæ™¨æ¸…ç†æ‰€æœ‰ä¸´æ—¶åª’ä½“æ–‡ä»¶
0 2 * * * cd /path/to/SmartDownloader && python3 scripts/temp_file_manager.py clean --older-than 6 --execute
```

#### systemdå®šæ—¶å™¨ï¼ˆLinuxï¼‰

```ini
# /etc/systemd/system/smartdownloader-cleanup.timer
[Unit]
Description=SmartDownloaderä¸´æ—¶æ–‡ä»¶æ¸…ç†
Requires=smartdownloader-cleanup.service

[Timer]
OnCalendar=hourly
Persistent=true

[Install]
WantedBy=timers.target
```

### æ€§èƒ½ä¼˜åŒ–

1. **è°ƒæ•´ç¼“å†²åŒºå¤§å°**ï¼š
   - å½“å‰ï¼š64KB chunks
   - å¤§æ–‡ä»¶å¯è€ƒè™‘å¢åŠ åˆ°128KBæˆ–256KB

2. **ç›‘æ§ç£ç›˜I/O**ï¼š
   - ä½¿ç”¨`iostat`ç›‘æ§I/Oä½¿ç”¨ç‡
   - è€ƒè™‘å°†ä¸´æ—¶ç›®å½•ç§»è‡³æ›´å¿«çš„SSD

3. **å¹¶å‘é™åˆ¶**ï¼š
   - æ ¹æ®å¯ç”¨ç£ç›˜ç©ºé—´é™åˆ¶åŒæ—¶ä¸‹è½½æ•°é‡
   - å¤§æ–‡ä»¶ä¸‹è½½æ—¶åŠ¨æ€è°ƒæ•´å¹¶å‘æ•°

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. ç£ç›˜ç©ºé—´ä¸è¶³
```bash
# ç—‡çŠ¶ï¼šä¸‹è½½å¤±è´¥ï¼Œæ—¥å¿—æ˜¾ç¤ºç©ºé—´ä¸è¶³
# è§£å†³ï¼š
temp-clean 0    # ç«‹å³æ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶
df -h /tmp      # æ£€æŸ¥ç©ºé—´é‡Šæ”¾æƒ…å†µ
```

#### 2. ä¸´æ—¶æ–‡ä»¶æœªæ¸…ç†
```bash
# ç—‡çŠ¶ï¼šä¸´æ—¶æ–‡ä»¶æŒç»­ç§¯ç´¯
# æ£€æŸ¥ï¼š
temp-status     # æŸ¥çœ‹å…·ä½“æƒ…å†µ

# è§£å†³ï¼š
temp-clean 0 --execute    # å¼ºåˆ¶æ¸…ç†æ‰€æœ‰æ–‡ä»¶
```

#### 3. æƒé™é—®é¢˜
```bash
# ç—‡çŠ¶ï¼šæ— æ³•åˆ é™¤ä¸´æ—¶æ–‡ä»¶
# è§£å†³ï¼š
sudo python3 scripts/temp_file_manager.py clean --execute
```

### è°ƒè¯•æ¨¡å¼

å¯ç”¨è¯¦ç»†æ—¥å¿—è®°å½•ï¼š

```python
import logging
logging.getLogger('web.main').setLevel(logging.DEBUG)
```

## ğŸ“‹ é…ç½®é€‰é¡¹

### ç¯å¢ƒå˜é‡

| å˜é‡å | æè¿° | é»˜è®¤å€¼ |
|--------|------|--------|
| `TMPDIR` | ä¸´æ—¶ç›®å½•è·¯å¾„ | ç³»ç»Ÿé»˜è®¤ |
| `TEMP_CLEANUP_HOURS` | è‡ªåŠ¨æ¸…ç†æ—¶é—´é˜ˆå€¼ | 1 |
| `TEMP_WARN_SPACE_GB` | ç£ç›˜ç©ºé—´è­¦å‘Šé˜ˆå€¼ | 1.0 |

### ä»£ç é…ç½®

```python
# åœ¨web/main.pyä¸­å¯è°ƒæ•´çš„å‚æ•°
chunk_size = 65536      # æµå¼ä¼ è¾“ç¼“å†²åŒºå¤§å°
max_retries = 3         # ç½‘ç»œé‡è¯•æ¬¡æ•°
temp_warn_space = 1.0   # ç£ç›˜ç©ºé—´è­¦å‘Šé˜ˆå€¼(GB)
```

## ğŸ”„ å‡çº§è·¯å¾„

### æœªæ¥æ”¹è¿›è®¡åˆ’

1. **å†…å­˜æµå¼ä¼ è¾“**ï¼š
   - å¯¹äºå°æ–‡ä»¶ï¼ˆ<50MBï¼‰è€ƒè™‘çº¯å†…å­˜æµå¼ä¼ è¾“
   - é¿å…ç£ç›˜I/Oå¼€é”€

2. **æ™ºèƒ½ç¼“å­˜**ï¼š
   - ç›¸åŒURLçš„é‡å¤è¯·æ±‚ä½¿ç”¨ç¼“å­˜
   - LRUç­–ç•¥ç®¡ç†ç¼“å­˜ç©ºé—´

3. **åˆ†å¸ƒå¼ä¸´æ—¶å­˜å‚¨**ï¼š
   - æ”¯æŒå¤šç£ç›˜ä¸´æ—¶ç›®å½•
   - è´Ÿè½½å‡è¡¡åˆ†é…ä¸‹è½½ä»»åŠ¡

4. **Webç•Œé¢**ï¼š
   - æ·»åŠ ä¸´æ—¶æ–‡ä»¶ç®¡ç†çš„Webç•Œé¢
   - å®æ—¶ç›‘æ§å’Œä¸€é”®æ¸…ç†åŠŸèƒ½

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [é…ç½®æŒ‡å—](CONFIG.md) - ç³»ç»Ÿé…ç½®é€‰é¡¹
- [æ–‡ä»¶ç®¡ç†æŒ‡å—](FILE_MANAGEMENT_GUIDE.md) - ä¸‹è½½æ–‡ä»¶ç®¡ç†
- [æŠ€æœ¯æŒ‡å—](SMART_DOWNLOAD_TECHNICAL_GUIDE.md) - ä¸‹è½½æŠ€æœ¯ç»†èŠ‚

---

*æœ€åæ›´æ–°ï¼š2025å¹´1æœˆ*
# ä¸‹è½½é€Ÿåº¦ä¼˜åŒ–æ€»ç»“æŠ¥å‘Š

## ğŸ“‹ æ¦‚è¿°

æœ¬æŠ¥å‘Šæ€»ç»“äº†SmartDownloaderé€šè¿‡ä¸´æ—¶æ–‡ä»¶ä¸‹è½½ç»“åˆå…ƒæ•°æ®åµŒå…¥æ¨¡å¼å®ç°çš„ä¸‹è½½é€Ÿåº¦ä¼˜åŒ–ã€‚è¿™ä¸€æ”¹è¿›æ˜¾è‘—æå‡äº†è§†é¢‘ä¸‹è½½æ€§èƒ½ï¼ŒåŒæ—¶ä¿æŒäº†å…ƒæ•°æ®åµŒå…¥åŠŸèƒ½ã€‚

## ğŸš€ æ€§èƒ½æå‡æ•ˆæœ

### ç”¨æˆ·åé¦ˆ
> "é€Ÿåº¦å˜çš„å¾ˆå¿«ï¼" - ç”¨æˆ·å®é™…æµ‹è¯•åé¦ˆ

### æ”¹è¿›å‰åå¯¹æ¯”

| æ–¹é¢ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡æ•ˆæœ |
|------|--------|--------|----------|
| **ä¸‹è½½æ¨¡å¼** | ç›´æ¥æµå¼ä¸‹è½½ | ä¸´æ—¶æ–‡ä»¶+å…ƒæ•°æ®åµŒå…¥ | âœ… é€Ÿåº¦æ˜¾è‘—æå‡ |
| **å…ƒæ•°æ®æ”¯æŒ** | âŒ æ—  | âœ… å®Œæ•´æ”¯æŒ | æ–°å¢åŠŸèƒ½ |
| **æ–‡ä»¶åå¤„ç†** | åŸºç¡€æ¸…ç† | æ™ºèƒ½ä¼˜åŒ– | âœ… æ›´ç®€æ´ |
| **ç½‘ç»œç¨³å®šæ€§** | åŸºç¡€é‡è¯• | æ™ºèƒ½é‡è¯•æœºåˆ¶ | âœ… æ›´å¯é  |

## ğŸ”§ æ ¸å¿ƒæŠ€æœ¯ä¿®æ”¹

### 1. æ–°å¢ç»„ä»¶

#### A. ç®€åŒ–æ ‡è¯†ç¬¦ç”Ÿæˆå™¨ (`utils.py`)
```python
def create_simplified_identifier(url: str, title: str = "") -> str:
    """ä»URLç”Ÿæˆç®€åŒ–æ ‡è¯†ç¬¦ï¼Œæ”¯æŒå¤šä¸ªä¸»æµå¹³å°"""
    # æ”¯æŒå¹³å°ï¼šX.comã€YouTubeã€Bilibiliã€å¾®åšã€æŠ–éŸ³ã€TikTok
    # æ ¼å¼ç¤ºä¾‹ï¼šx-1234567890, yt-dQw4w9WG, bili-17x411w7
```

**æ–°å¢å†…å®¹**ï¼š
- å¤šå¹³å°URLè§£æé€»è¾‘
- æ™ºèƒ½IDæå–ç®—æ³•
- ASCIIå®‰å…¨å¤„ç†
- é€šç”¨å›é€€æœºåˆ¶

#### B. å…ƒæ•°æ®åµŒå…¥å‘½ä»¤æ„å»ºå™¨ (`core/command_builder.py`)
```python
def build_streaming_download_cmd(self, output_path: str, url: str, format_spec: str = "best") -> List[str]:
    """æ„å»ºæµè§ˆå™¨ç›´æµä¸‹è½½å‘½ä»¤ï¼ŒåŒ…å«ç®€åŒ–çš„æ¥æºå…ƒæ•°æ®"""
    cmd.extend([
        "--add-metadata",      # æ·»åŠ å…ƒæ•°æ®åˆ°æ–‡ä»¶
        "--embed-metadata",    # åµŒå…¥å…ƒæ•°æ®åˆ°å®¹å™¨
        "--xattrs",           # å†™å…¥macOS/Linuxæ‰©å±•å±æ€§
        "--replace-in-metadata", "webpage_url", "^.*$", simplified_source,
        "--replace-in-metadata", "comment", "^.*$", f"Source: {simplified_source}",
    ])
```

**æ–°å¢å†…å®¹**ï¼š
- å…ƒæ•°æ®åµŒå…¥å‚æ•°é›†æˆ
- ç®€åŒ–æ¥æºä¿¡æ¯æ›¿æ¢
- å¤šå±‚å…ƒæ•°æ®å†™å…¥ç­–ç•¥

#### C. ä¸´æ—¶æ–‡ä»¶ç®¡ç†è„šæœ¬ (`scripts/temp_file_manager.py`)
```python
class TempFileManager:
    """å®Œæ•´çš„ä¸´æ—¶æ–‡ä»¶ç›‘æ§å’Œæ¸…ç†å·¥å…·"""
    - çŠ¶æ€ç›‘æ§
    - æ™ºèƒ½æ¸…ç†
    - å®‰å…¨é¢„è§ˆ
    - è‡ªåŠ¨åŒ–æ”¯æŒ
```

**æ–°å¢å†…å®¹**ï¼š
- 686è¡Œå®Œæ•´ç®¡ç†è„šæœ¬
- ç£ç›˜ç©ºé—´ç›‘æ§
- åˆ†ç±»æ–‡ä»¶ç»Ÿè®¡
- å¤šç§æ¸…ç†ç­–ç•¥

### 2. æ ¸å¿ƒæµç¨‹é‡æ„

#### A. ä¸‹è½½æµç¨‹ä¼˜åŒ– (`web/main.py`)

**æ”¹è¿›å‰**ï¼š
```python
# ç›´æ¥æµå¼ä¸‹è½½ï¼Œæ— å…ƒæ•°æ®
process = await asyncio.create_subprocess_exec(*cmd, stdout=PIPE)
async for chunk in process.stdout:
    yield chunk
```

**æ”¹è¿›å**ï¼š
```python
# ä¸´æ—¶æ–‡ä»¶ + å…ƒæ•°æ®åµŒå…¥ + é«˜æ•ˆä¼ è¾“
with tempfile.NamedTemporaryFile(suffix=f".{file_extension}", delete=False) as temp_file:
    temp_path = temp_file.name

# ä½¿ç”¨å…ƒæ•°æ®åµŒå…¥å‘½ä»¤ä¸‹è½½
cmd = command_builder.build_streaming_download_cmd(temp_path, url, format_id)
process = await asyncio.create_subprocess_exec(*cmd)

# 64KBé«˜æ•ˆæµå¼ä¼ è¾“
chunk_size = 65536
async with aiofiles.open(temp_path, 'rb') as f:
    while True:
        chunk = await f.read(chunk_size)
        if not chunk: break
        yield chunk

# è‡ªåŠ¨æ¸…ç†
finally:
    os.unlink(temp_path)
```

#### B. æ™ºèƒ½é‡è¯•æœºåˆ¶

**æ–°å¢åŠŸèƒ½**ï¼š
```python
max_retries = 3
retryable_errors = [
    "SSL:", "EOF occurred in violation of protocol",
    "Connection reset by peer", "Unable to download JSON metadata",
    "timeout", "network"
]

# æŒ‡æ•°é€€é¿ç­–ç•¥
await asyncio.sleep(2 ** attempt)  # 2s, 4s
```

### 3. æ–‡ä»¶åä¼˜åŒ–ç³»ç»Ÿ

#### A. æ™ºèƒ½æ¸…ç†å‡½æ•°
```python
def sanitize_filename(title_str):
    # 1. ç§»é™¤URLé“¾æ¥
    title_str = re.sub(r'https?://[^\s]+', '', title_str)
    
    # 2. ç§»é™¤æ–‡ä»¶ç³»ç»Ÿä¸æ”¯æŒå­—ç¬¦ï¼ˆå®Œå…¨ç§»é™¤ï¼Œä¸ç”¨å…¨è§’æ›¿æ¢ï¼‰
    forbidden_chars = {"<": "", ">": "", ":": "", '"': "", ...}
    
    # 3. æ™ºèƒ½æˆªæ–­å’Œå•è¯è¾¹ç•Œå¤„ç†
```

**æ”¹è¿›æ•ˆæœ**ï¼š
- ä» `Punch Cat - httpsï¼šï¼ï¼t.coï¼rLyrbNb2wA_720x1280 (2).mp4`
- åˆ° `Punch Cat_720x1280.mp4`

## âš¡ é€Ÿåº¦ä¼˜åŒ–å…³é”®å› ç´ 

### 1. yt-dlpå‘½ä»¤ä¼˜åŒ–
```python
cmd.extend([
    "--no-check-certificate",     # è·³è¿‡SSLè¯ä¹¦æ£€æŸ¥
    "--prefer-insecure",          # ä¼˜å…ˆä½¿ç”¨HTTP
    "--youtube-skip-dash-manifest", # YouTube: è·³è¿‡DASHæ¸…å•
    "--youtube-skip-hls-manifest",  # YouTube: è·³è¿‡HLSæ¸…å•
    "--no-part",                   # ä¸åˆ›å»ºéƒ¨åˆ†æ–‡ä»¶
    "--no-mtime",                  # ä¸è®¾ç½®ä¿®æ”¹æ—¶é—´
    "--concurrent-fragments", "4",  # å¹¶å‘ç‰‡æ®µä¸‹è½½
    "--fragment-retries", "infinite", # æ— é™é‡è¯•ç‰‡æ®µ
])
```

### 2. æµå¼ä¼ è¾“ä¼˜åŒ–
- **ç¼“å†²åŒºå¢å¤§**ï¼šä»16KBæå‡åˆ°64KB
- **å¼‚æ­¥I/O**ï¼šä½¿ç”¨`aiofiles`å¼‚æ­¥æ–‡ä»¶æ“ä½œ
- **å†…å­˜æ•ˆç‡**ï¼šé¿å…æ•´ä¸ªæ–‡ä»¶åŠ è½½åˆ°å†…å­˜

### 3. ç½‘ç»œå±‚ä¼˜åŒ–
- **å¹¶å‘ç‰‡æ®µä¸‹è½½**ï¼š4ä¸ªå¹¶å‘è¿æ¥
- **æ™ºèƒ½é‡è¯•**ï¼šåªå¯¹ç½‘ç»œé”™è¯¯é‡è¯•
- **è¿æ¥å¤ç”¨**ï¼šé¿å…é‡å¤SSLæ¡æ‰‹

## ğŸ“Š æ€§èƒ½åˆ†æ

### ä¸‹è½½é€Ÿåº¦æå‡åŸå› 

1. **ç½‘ç»œå±‚ä¼˜åŒ–**ï¼š
   - å¹¶å‘ç‰‡æ®µä¸‹è½½æå‡ååé‡
   - è·³è¿‡ä¸å¿…è¦çš„SSLæ£€æŸ¥
   - ä¼˜åŒ–çš„é‡è¯•å’Œé€€é¿ç­–ç•¥

2. **I/Oä¼˜åŒ–**ï¼š
   - æ›´å¤§çš„ç¼“å†²åŒºå‡å°‘ç³»ç»Ÿè°ƒç”¨
   - å¼‚æ­¥æ–‡ä»¶æ“ä½œé¿å…é˜»å¡
   - ä¸´æ—¶æ–‡ä»¶çš„é¡ºåºå†™å…¥æ¨¡å¼

3. **åè®®ä¼˜åŒ–**ï¼š
   - è·³è¿‡DASH/HLSæ¸…å•è§£æ
   - ä¼˜å…ˆä½¿ç”¨HTTPè€ŒéHTTPSï¼ˆé€‚å½“åœºæ™¯ï¼‰
   - æ— é™ç‰‡æ®µé‡è¯•ç¡®ä¿å®Œæ•´æ€§

### å®é™…æµ‹è¯•æ•°æ®

**X.comè§†é¢‘ä¸‹è½½ç¤ºä¾‹**ï¼š
- **æ–‡ä»¶å¤§å°**ï¼š1,842,649 bytes (â‰ˆ1.76MB)
- **æ ¼å¼**ï¼šhttp-2176 (720x1280)
- **ç”¨æˆ·åé¦ˆ**ï¼šé€Ÿåº¦æ˜¾è‘—æå‡

## ğŸ”„ æ¶æ„å˜åŒ–

### æ–°å¢æ¨¡å—å…³ç³»å›¾

```mermaid
graph TD
    A[Webè¯·æ±‚] --> B[ä¸‹è½½æµå¤„ç†å™¨]
    B --> C[CommandBuilder]
    C --> D[create_simplified_identifier]
    C --> E[build_streaming_download_cmd]
    B --> F[ä¸´æ—¶æ–‡ä»¶ç®¡ç†]
    F --> G[å…ƒæ•°æ®åµŒå…¥ä¸‹è½½]
    G --> H[64KBæµå¼ä¼ è¾“]
    H --> I[è‡ªåŠ¨æ¸…ç†]
    
    J[TempFileManager] --> F
    K[æ™ºèƒ½é‡è¯•æœºåˆ¶] --> G
```

### å…³é”®ä¿®æ”¹ç‚¹

| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ | è¡Œæ•°å˜åŒ– | ä¸»è¦åŠŸèƒ½ |
|------|----------|----------|----------|
| `utils.py` | æ–°å¢ | +77è¡Œ | ç®€åŒ–æ ‡è¯†ç¬¦ç”Ÿæˆ |
| `core/command_builder.py` | æ–°å¢æ–¹æ³• | +46è¡Œ | å…ƒæ•°æ®åµŒå…¥å‘½ä»¤ |
| `web/main.py` | é‡æ„ | ~200è¡Œä¿®æ”¹ | ä¸´æ—¶æ–‡ä»¶ä¸‹è½½æµç¨‹ |
| `scripts/temp_file_manager.py` | æ–°å¢ | +686è¡Œ | ä¸´æ—¶æ–‡ä»¶ç®¡ç†å·¥å…· |
| `scripts/temp_utils.sh` | æ–°å¢ | +67è¡Œ | ä¾¿æ·ç®¡ç†å‘½ä»¤ |

## ğŸ¯ æ ¸å¿ƒåˆ›æ–°ç‚¹

### 1. å…ƒæ•°æ®é©±åŠ¨çš„æ€§èƒ½ä¼˜åŒ–
- **ä¸ä»…ä»…æ˜¯åŠŸèƒ½**ï¼šå…ƒæ•°æ®åµŒå…¥æ¨¡å¼æ„å¤–åœ°å¸¦æ¥äº†æ€§èƒ½æå‡
- **å‚æ•°ååŒ**ï¼šå¤šä¸ªyt-dlpä¼˜åŒ–å‚æ•°çš„ååŒä½œç”¨
- **ç½‘ç»œæ•ˆç‡**ï¼šå¹¶å‘ä¸‹è½½å’Œé‡è¯•æœºåˆ¶çš„æ”¹è¿›

### 2. æ™ºèƒ½ä¸´æ—¶æ–‡ä»¶ç®¡ç†
- **é›¶æ®‹ç•™**ï¼šç¡®ä¿ä¸´æ—¶æ–‡ä»¶100%æ¸…ç†
- **ç›‘æ§å·¥å…·**ï¼šå®Œæ•´çš„ç®¡ç†å’Œç›‘æ§ä½“ç³»
- **å®‰å…¨æœºåˆ¶**ï¼šå¤šå±‚ä¿æŠ¤é¿å…ç£ç›˜ç©ºé—´é—®é¢˜

### 3. ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- **æ–‡ä»¶åç®€åŒ–**ï¼šä»å¤æ‚URLåˆ°ç®€æ´æ ¼å¼
- **å…ƒæ•°æ®å¯è§**ï¼šè§†é¢‘å±æ€§ä¸­æ˜¾ç¤ºç®€åŒ–æ¥æº
- **é”™è¯¯å¤„ç†**ï¼šæ™ºèƒ½é‡è¯•å‡å°‘ä¸‹è½½å¤±è´¥

## ğŸ’¡ ç»éªŒæ€»ç»“

### æ„å¤–å‘ç°
1. **ä¸´æ—¶æ–‡ä»¶æ¨¡å¼çš„æ€§èƒ½ä¼˜åŠ¿**ï¼šåŸæœ¬ä¸ºäº†å…ƒæ•°æ®åµŒå…¥è€Œé‡‡ç”¨çš„ä¸´æ—¶æ–‡ä»¶æ¨¡å¼ï¼Œæ„å¤–åœ°æå‡äº†ä¸‹è½½é€Ÿåº¦
2. **å‚æ•°ç»„åˆæ•ˆåº”**ï¼šå¤šä¸ªyt-dlpä¼˜åŒ–å‚æ•°çš„ç»„åˆä½¿ç”¨äº§ç”Ÿäº†è¶…é¢„æœŸçš„æ•ˆæœ
3. **ç½‘ç»œä¼˜åŒ–çš„é‡è¦æ€§**ï¼šè·³è¿‡ä¸å¿…è¦çš„ç½‘ç»œè¯·æ±‚å¯¹æ•´ä½“æ€§èƒ½å½±å“æ˜¾è‘—

### ä¼˜åŒ–ç­–ç•¥
1. **åŠŸèƒ½ä¸æ€§èƒ½å¹¶é‡**ï¼šåœ¨å®ç°æ–°åŠŸèƒ½çš„åŒæ—¶è€ƒè™‘æ€§èƒ½å½±å“
2. **æµ‹è¯•é©±åŠ¨**ï¼šç”¨æˆ·åé¦ˆéªŒè¯äº†æŠ€æœ¯æ”¹è¿›çš„æœ‰æ•ˆæ€§
3. **å·¥å…·åŒ–ç®¡ç†**ï¼šå¤æ‚åŠŸèƒ½éœ€è¦é…å¥—çš„ç®¡ç†å·¥å…·

## ğŸ”® æœªæ¥æ”¹è¿›æ–¹å‘

### 1. è¿›ä¸€æ­¥æ€§èƒ½ä¼˜åŒ–
- **å†…å­˜æµå¼å¤„ç†**ï¼šå°æ–‡ä»¶(<50MB)è€ƒè™‘çº¯å†…å­˜å¤„ç†
- **æ™ºèƒ½ç¼“å­˜**ï¼šç›¸åŒURLçš„é‡å¤è¯·æ±‚ä½¿ç”¨ç¼“å­˜
- **åˆ†å¸ƒå¼ä¸‹è½½**ï¼šæ”¯æŒå¤šæœåŠ¡å™¨å¹¶è¡Œä¸‹è½½

### 2. åŠŸèƒ½æ‰©å±•
- **æ›´å¤šå¹³å°æ”¯æŒ**ï¼šæ‰©å±•ç®€åŒ–æ ‡è¯†ç¬¦ç”Ÿæˆå™¨
- **è‡ªå®šä¹‰å…ƒæ•°æ®**ï¼šå…è®¸ç”¨æˆ·å®šä¹‰å…ƒæ•°æ®å­—æ®µ
- **æ‰¹é‡å¤„ç†**ï¼šæ”¯æŒæ‰¹é‡ä¸‹è½½çš„ä¸´æ—¶æ–‡ä»¶ç®¡ç†

### 3. è¿ç»´è‡ªåŠ¨åŒ–
- **æ€§èƒ½ç›‘æ§**ï¼šæ·»åŠ ä¸‹è½½é€Ÿåº¦å’ŒæˆåŠŸç‡ç›‘æ§
- **è‡ªåŠ¨è°ƒä¼˜**ï¼šæ ¹æ®ç½‘ç»œçŠ¶å†µè‡ªåŠ¨è°ƒæ•´å‚æ•°
- **å‘Šè­¦æœºåˆ¶**ï¼šç£ç›˜ç©ºé—´å’Œé”™è¯¯ç‡å‘Šè­¦

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å…ƒæ•°æ®åµŒå…¥æŒ‡å—](METADATA_EMBEDDING_GUIDE.md) - è¯¦ç»†æŠ€æœ¯å®ç°
- [ä¸´æ—¶æ–‡ä»¶ç®¡ç†æŒ‡å—](TEMP_FILE_MANAGEMENT.md) - å®Œæ•´ç®¡ç†æ–¹æ¡ˆ
- [æ™ºèƒ½ä¸‹è½½æŠ€æœ¯æŒ‡å—](SMART_DOWNLOAD_TECHNICAL_GUIDE.md) - ä¸‹è½½æŠ€æœ¯ç»†èŠ‚

---

*æœ¬æŠ¥å‘Šæ€»ç»“äº†é€šè¿‡ä¸´æ—¶æ–‡ä»¶+å…ƒæ•°æ®åµŒå…¥æ¨¡å¼å®ç°çš„ä¸‹è½½é€Ÿåº¦ä¼˜åŒ–ï¼Œæ¶µç›–äº†æ‰€æœ‰æŠ€æœ¯ä¿®æ”¹å’Œæ€§èƒ½æå‡è¦ç‚¹ã€‚*  
*æœ€åæ›´æ–°ï¼š2025å¹´1æœˆ*
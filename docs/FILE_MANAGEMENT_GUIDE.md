# 文件管理方案说明

## 概述

这个方案实现了一个完整的文件暂存和管理系统，具有以下特点：

1. **自动定时清理**：文件在服务器存储一定时间后自动删除
2. **无限次下载**：在过期时间内，用户可以无限次点击"resave"按钮重新下载
3. **立即删除**：用户点击"delete"按钮时，立即删除文件并恢复下载前状态

## 技术实现

### 后端实现

#### 1. 文件存储机制
- 下载完成后，文件存储在 `downloads/` 目录
- 在Redis中创建 `download:{task_id}` 记录，包含：
  - `file_path`: 文件完整路径
  - `filename`: 文件名
  - `media_type`: 媒体类型
  - `created_at`: 创建时间

#### 2. 定时清理任务 (`cleanup_expired_files`)
- **执行频率**: 每30分钟运行一次
- **清理逻辑**:
  - 清理孤立文件（无Redis记录且超过90分钟的文件）
  - Redis记录会自动过期（1小时TTL）
  - 当Redis记录过期时，对应文件也会被清理

#### 3. 立即删除API (`DELETE /download/file/{task_id}`)
- 立即删除服务器上的文件
- 清理对应的Redis记录
- 返回删除结果（文件大小、删除状态等）

### 前端实现

#### 1. 下载完成状态
- 显示文件下载完成的状态
- 提供"resave"和"delete"两个按钮
- 保持与下载前相同的容器高度

#### 2. Resave功能
- 通过 `/download/file/{task_id}` 端点重新下载文件
- 无限次重新下载（在过期时间内）

#### 3. Delete功能
- 立即调用删除API
- 成功删除后恢复到下载前的原始状态
- 无需用户确认，直接删除

## 配置说明

### 文件过期时间
- **Redis记录过期**: 1小时（3600秒）
- **孤立文件清理**: 90分钟（5400秒）
- **定时清理频率**: 每30分钟

### 启动服务

1. **启动Web服务器**:
   ```bash
   python start_web_server.py
   ```

2. **启动Celery Worker**:
   ```bash
   python start_celery_worker.py
   ```

3. **启动Celery Beat（定时任务调度器）**:
   ```bash
   python start_celery_beat.py
   ```

## 文件生命周期

```
1. 用户发起下载 
   ↓
2. 文件下载完成，存储到downloads/目录
   ↓  
3. 在Redis中创建记录，设置1小时过期
   ↓
4. 前端显示"resave"和"delete"按钮
   ↓
5a. 用户点击"resave" → 重新下载文件
5b. 用户点击"delete" → 立即删除文件并恢复状态  
5c. 1小时后Redis记录自动过期
   ↓
6. 定时清理任务每30分钟检查并清理孤立文件
```

## 优势

1. **用户友好**: 下载完成后可以多次保存，不需要重新下载
2. **服务器优化**: 自动清理过期文件，防止磁盘空间无限增长
3. **灵活管理**: 用户可以主动删除不需要的文件
4. **状态一致**: 删除后恢复到下载前的完整状态
5. **无侵扰**: 删除操作无需确认，减少用户操作步骤

## 监控和维护

- 清理任务会记录详细日志，包括清理的文件数量和释放的空间
- Redis记录自动过期，减少手动维护需求
- 支持通过日志监控清理任务的执行情况
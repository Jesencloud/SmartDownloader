# ä¸‹è½½æ¨¡å¼é€‚ç”¨æ€§åˆ†ææŠ¥å‘Š

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£åˆ†æSmartDownloaderçš„ä¼˜åŒ–ä¸‹è½½æ¨¡å¼ï¼ˆä¸´æ—¶æ–‡ä»¶+å…ƒæ•°æ®åµŒå…¥ï¼‰åœ¨ä¸åŒè§†é¢‘æ ¼å¼ä¸‹çš„é€‚ç”¨æ€§ï¼Œç‰¹åˆ«æ˜¯å•ä¸€æºï¼ˆcomplete streamï¼‰ä¸è§†é¢‘éŸ³é¢‘åˆ†æµï¼ˆseparate streamsï¼‰åœºæ™¯çš„å·®å¼‚ã€‚

## ğŸ¯ æ ¸å¿ƒå‘ç°

### å…³é”®ç»“è®º
å½“å‰çš„**ä¸´æ—¶æ–‡ä»¶+å…ƒæ•°æ®åµŒå…¥ä¼˜åŒ–æ¨¡å¼**ä¸»è¦é€‚ç”¨äº**å•ä¸€æºä¸‹è½½**ï¼Œå¯¹äº**è§†é¢‘éŸ³é¢‘åˆ†æµ**åœºæ™¯å­˜åœ¨æŠ€æœ¯é™åˆ¶å’Œå¤æ‚æ€§æŒ‘æˆ˜ã€‚

## ğŸ“Š æ¨¡å¼é€‚ç”¨æ€§å¯¹æ¯”

### âœ… **é€‚ç”¨åœºæ™¯ï¼šå•ä¸€æºï¼ˆComplete Streamï¼‰**

| å¹³å° | æ ¼å¼ç¤ºä¾‹ | æ ¼å¼ç‰¹å¾ | ä¼˜åŒ–æ•ˆæœ |
|------|----------|----------|----------|
| **X.com/Twitter** | `http-2176` | `vcodec=None, acodec=None` å®Œæ•´æµ | âœ… é€Ÿåº¦æ˜¾è‘—æå‡ |
| **YouTubeç›´æ’­** | `best[ext=mp4]` | é¢„åˆå¹¶è§†é¢‘+éŸ³é¢‘ | âœ… å…ƒæ•°æ®åµŒå…¥æˆåŠŸ |
| **Bilibiliéƒ¨åˆ†æ ¼å¼** | `dash-video` | æŸäº›mp4å®Œæ•´æµ | âœ… æ–‡ä»¶åä¼˜åŒ– |
| **å…¶ä»–å¹³å°** | Complete streams | åŒ…å«å®Œæ•´éŸ³è§†é¢‘æ•°æ® | âœ… ç½‘ç»œé‡è¯•ä¼˜åŒ– |

#### æŠ€æœ¯å®ç°
```python
# å•ä¸€æºæ£€æµ‹é€»è¾‘
if (
    (vcodec not in ("none", None, "") and acodec not in ("none", None, ""))
    or (vcodec == "unknown" and acodec == "unknown")
    or (vcodec is None and acodec is None)  # X.comç­‰å¹³å°çš„å®Œæ•´æµ
):
    complete_formats_raw.append(f)
    # æ”¯æŒbrowser_download=Trueï¼Œèµ°ä¼˜åŒ–æµç¨‹
```

#### ä¼˜åŒ–æµç¨‹
```mermaid
graph TD
    A[å•ä¸€æºè¯·æ±‚] --> B[åˆ›å»ºä¸´æ—¶æ–‡ä»¶]
    B --> C[å…ƒæ•°æ®åµŒå…¥ä¸‹è½½]
    C --> D[64KBé«˜æ•ˆæµå¼ä¼ è¾“]
    D --> E[è‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶]
    
    style A fill:#e1f5fe
    style C fill:#c8e6c9
    style D fill:#fff3e0
```

### âŒ **ä¸é€‚ç”¨åœºæ™¯ï¼šè§†é¢‘éŸ³é¢‘åˆ†æµï¼ˆSeparate Streamsï¼‰**

| å¹³å° | æ ¼å¼ç¤ºä¾‹ | æ ¼å¼ç‰¹å¾ | å½“å‰å¤„ç†æ–¹å¼ |
|------|----------|----------|--------------|
| **YouTube 1080p+** | `video_only + audio_only` | éœ€è¦FFmpegåˆå¹¶ | âŒ Celeryåå°å¤„ç† |
| **YouTube 4K** | `bestvideo + bestaudio` | é«˜è´¨é‡åˆ†ç¦»æµ | âŒ ä¼ ç»Ÿä¸‹è½½æ¨¡å¼ |
| **Bilibilié«˜æ¸…** | `dash-video + dash-audio` | åˆ†æµæ ¼å¼ | âŒ åå°åˆå¹¶å¤„ç† |
| **å¤§å¤šæ•°é«˜åˆ†è¾¨ç‡å†…å®¹** | Video + Audio streams | éœ€è¦åå¤„ç† | âŒ ä¸èµ°ä¼˜åŒ–æµç¨‹ |

#### ç³»ç»Ÿè¯†åˆ«æœºåˆ¶
```python
# åˆ†æµæ ¼å¼æ ‡è®°
supports_browser_download=False  # ä¸æ”¯æŒç›´æ¥æµè§ˆå™¨ä¸‹è½½
needs_merge=True                 # éœ€è¦åˆå¹¶å¤„ç†
is_complete_stream=False         # ä¸æ˜¯å®Œæ•´æµ

# è·¯ç”±åˆ°ä¼ ç»ŸCeleryå¤„ç†
if not format.supports_browser_download:
    return await traditional_celery_download()
```

#### åˆ†æµå¤„ç†æµç¨‹
```mermaid
graph TD
    A[åˆ†æµè¯·æ±‚] --> B[Celeryä»»åŠ¡é˜Ÿåˆ—]
    B --> C[å¹¶è¡Œä¸‹è½½è§†é¢‘+éŸ³é¢‘]
    C --> D[FFmpegåˆå¹¶]
    D --> E[æ–‡ä»¶å­˜å‚¨]
    E --> F[ä¸‹è½½é“¾æ¥è¿”å›]
    
    style A fill:#ffebee
    style D fill:#fff3e0
    style F fill:#e8f5e8
```

## ğŸ”§ æŠ€æœ¯æŒ‘æˆ˜åˆ†æ

### 1. **å…ƒæ•°æ®åµŒå…¥çš„å¤æ‚æ€§**

#### å•ä¸€æºæ¨¡å¼ï¼ˆå½“å‰ï¼‰
```python
# ç®€å•ç›´æ¥çš„å…ƒæ•°æ®åµŒå…¥
cmd.extend([
    "--add-metadata",
    "--embed-metadata", 
    "--xattrs",
    "--replace-in-metadata", "webpage_url", "^.*$", simplified_source,
    "--replace-in-metadata", "comment", "^.*$", f"Source: {simplified_source}",
])
```

#### åˆ†æµæ¨¡å¼çš„æŒ‘æˆ˜
```python
# å¤æ‚çš„å¤šæ–‡ä»¶å…ƒæ•°æ®å¤„ç†
# é—®é¢˜1: å…ƒæ•°æ®åµŒå…¥åˆ°å“ªä¸ªæ–‡ä»¶ï¼Ÿ
video_file = download_video_only()    # è§†é¢‘æ–‡ä»¶
audio_file = download_audio_only()    # éŸ³é¢‘æ–‡ä»¶

# é—®é¢˜2: FFmpegåˆå¹¶æ—¶å…ƒæ•°æ®æ˜¯å¦ä¿ç•™ï¼Ÿ
merged_file = ffmpeg_merge(video_file, audio_file, metadata=simplified_source)

# é—®é¢˜3: ä¸´æ—¶æ–‡ä»¶ç®¡ç†å¤æ‚åº¦å¢åŠ 
cleanup([video_file, audio_file, merged_file])  # 3å€ä¸´æ—¶æ–‡ä»¶
```

### 2. **æ€§èƒ½å½±å“å¯¹æ¯”**

| å¤„ç†é˜¶æ®µ | å•ä¸€æºæ¨¡å¼ | åˆ†æµæ¨¡å¼ |
|----------|------------|----------|
| **ä¸‹è½½** | 1ä¸ªæ–‡ä»¶ä¸‹è½½ | 2ä¸ªæ–‡ä»¶å¹¶è¡Œä¸‹è½½ |
| **å¤„ç†** | å…ƒæ•°æ®åµŒå…¥ | FFmpegåˆå¹¶+å…ƒæ•°æ® |
| **ä¸´æ—¶æ–‡ä»¶** | 1ä¸ªä¸´æ—¶æ–‡ä»¶ | 3ä¸ªä¸´æ—¶æ–‡ä»¶ |
| **I/Oæ“ä½œ** | 1æ¬¡å†™å…¥+1æ¬¡è¯»å– | 3æ¬¡å†™å…¥+1æ¬¡è¯»å– |
| **å†…å­˜ä½¿ç”¨** | 64KBç¼“å†² | FFmpegåˆå¹¶å†…å­˜ |

### 3. **ç³»ç»Ÿèµ„æºæ¶ˆè€—**

```python
# å•ä¸€æºèµ„æºä½¿ç”¨
temp_space = video_file_size        # 1å€æ–‡ä»¶å¤§å°
processing_time = download_time     # çº¯ä¸‹è½½æ—¶é—´
network_connections = 1             # å•ä¸€è¿æ¥

# åˆ†æµèµ„æºä½¿ç”¨ï¼ˆç†è®ºä¸Šï¼‰
temp_space = video_size + audio_size + merged_size  # 3å€æ–‡ä»¶å¤§å°
processing_time = max(video_dl, audio_dl) + merge_time  # ä¸‹è½½+åˆå¹¶æ—¶é—´
network_connections = 2             # åŒè¿æ¥
```

## ğŸ“ˆ å®é™…æ€§èƒ½æµ‹è¯•æ•°æ®

### X.comå•ä¸€æºä¸‹è½½ï¼ˆä¼˜åŒ–æ¨¡å¼ï¼‰
```
æ ¼å¼: http-2176 (720x1280)
æ–‡ä»¶å¤§å°: 1,842,649 bytes (â‰ˆ1.76MB)
ç”¨æˆ·åé¦ˆ: "é€Ÿåº¦å˜çš„å¾ˆå¿«ï¼"
ä¸´æ—¶æ–‡ä»¶: 1ä¸ªï¼Œè‡ªåŠ¨æ¸…ç†
å…ƒæ•°æ®: æˆåŠŸåµŒå…¥ç®€åŒ–æ¥æº "x-7277823619"
```

### YouTubeåˆ†æµä¸‹è½½ï¼ˆä¼ ç»Ÿæ¨¡å¼ï¼‰
```
æ ¼å¼: bestvideo[ext=mp4]+bestaudio[ext=m4a]
å¤„ç†æ–¹å¼: Celeryåå°ä»»åŠ¡
ä¸´æ—¶æ–‡ä»¶: è§†é¢‘+éŸ³é¢‘+åˆå¹¶ = 3ä¸ªæ–‡ä»¶
å…ƒæ•°æ®: ä¾èµ–åå°ä»»åŠ¡å®ç°
ç”¨æˆ·ä½“éªŒ: ä¸‹è½½é“¾æ¥å¼‚æ­¥è¿”å›
```

## ğŸ¯ æ™ºèƒ½è·¯ç”±æœºåˆ¶

### å½“å‰ç³»ç»Ÿçš„æ™ºèƒ½é€‰æ‹©
```python
def select_download_mode(format_info):
    if format_info.supports_browser_download:
        # æ¡ä»¶ï¼šcomplete stream + mp4 + æœ‰æ•ˆåˆ†è¾¨ç‡
        return "optimized_temp_file_mode"  # ä½¿ç”¨ä¼˜åŒ–æ¨¡å¼
    else:
        # æ¡ä»¶ï¼šneeds_merge=True æˆ– åˆ†æµæ ¼å¼
        return "traditional_celery_mode"   # ä½¿ç”¨ä¼ ç»Ÿæ¨¡å¼
```

### è·¯ç”±å†³ç­–æµç¨‹
```mermaid
flowchart TD
    A[ä¸‹è½½è¯·æ±‚] --> B{æ ¼å¼æ£€æµ‹}
    B -->|complete stream| C[å•ä¸€æºæ¨¡å¼]
    B -->|separate streams| D[åˆ†æµæ¨¡å¼]
    
    C --> E[ä¸´æ—¶æ–‡ä»¶+å…ƒæ•°æ®åµŒå…¥]
    E --> F[64KBæµå¼ä¼ è¾“]
    F --> G[è‡ªåŠ¨æ¸…ç†]
    
    D --> H[Celeryåå°ä»»åŠ¡]
    H --> I[å¹¶è¡Œä¸‹è½½+åˆå¹¶]
    I --> J[æ–‡ä»¶å­˜å‚¨+é“¾æ¥è¿”å›]
    
    style C fill:#c8e6c9
    style D fill:#ffecb3
    style E fill:#e1f5fe
    style I fill:#fff3e0
```

## ğŸ’¡ è®¾è®¡å†³ç­–åˆ†æ

### ä¸ºä»€ä¹ˆä¸“æ³¨å•ä¸€æºä¼˜åŒ–ï¼Ÿ

#### 1. **æŠ€æœ¯åˆç†æ€§**
- **å¤æ‚åº¦å¯æ§**ï¼šå•ä¸€æºçš„ä¼˜åŒ–å®ç°ç›¸å¯¹ç®€å•ç¨³å®š
- **æ€§èƒ½æ”¶ç›Šæ˜æ˜¾**ï¼šç”¨æˆ·åé¦ˆè¯å®äº†æ˜¾è‘—çš„é€Ÿåº¦æå‡
- **åŠŸèƒ½å®Œæ•´æ€§**ï¼šå…ƒæ•°æ®åµŒå…¥åŠŸèƒ½å¾—åˆ°å®Œæ•´å®ç°

#### 2. **ç”¨æˆ·ä½“éªŒè€ƒè™‘**
- **å³æ—¶åé¦ˆ**ï¼šå•ä¸€æºæ”¯æŒå®æ—¶æµå¼ä¸‹è½½
- **æ–‡ä»¶åä¼˜åŒ–**ï¼šé¿å…å¤æ‚URLå¯¼è‡´çš„æ–‡ä»¶åé—®é¢˜
- **ç½‘ç»œç¨³å®šæ€§**ï¼šæ™ºèƒ½é‡è¯•æœºåˆ¶æå‡ä¸‹è½½æˆåŠŸç‡

#### 3. **å¹³å°ç‰¹æ€§åŒ¹é…**
- **X.comä¼˜åŠ¿**ï¼šå®Œç¾é€‚é…X.comçš„complete streamæ ¼å¼
- **ç§»åŠ¨ç«¯å‹å¥½**ï¼šè¾ƒå°æ–‡ä»¶å¤§å°é€‚åˆç§»åŠ¨ç½‘ç»œç¯å¢ƒ
- **ç¤¾äº¤åª’ä½“ç‰¹å¾**ï¼šçŸ­è§†é¢‘å†…å®¹å¤šä¸ºå•ä¸€æºæ ¼å¼

## ğŸ”„ æœªæ¥æ‰©å±•æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šæ‰©å±•ä¼˜åŒ–æ¨¡å¼æ”¯æŒåˆ†æµ
```python
async def enhanced_temp_file_mode():
    """æ‰©å±•çš„ä¸´æ—¶æ–‡ä»¶æ¨¡å¼ï¼Œæ”¯æŒåˆ†æµå¤„ç†"""
    # 1. å¹¶è¡Œä¸‹è½½
    video_temp, audio_temp = await asyncio.gather(
        download_video_part(video_format),
        download_audio_part(audio_format)
    )
    
    # 2. å¿«é€Ÿåˆå¹¶+å…ƒæ•°æ®åµŒå…¥
    merged_temp = await ffmpeg_merge_with_metadata(
        video_temp, audio_temp, 
        metadata={"source": simplified_source}
    )
    
    # 3. æµå¼ä¼ è¾“
    async for chunk in stream_file(merged_temp):
        yield chunk
    
    # 4. ä¸‰é‡æ¸…ç†
    cleanup_files([video_temp, audio_temp, merged_temp])
```

**ä¼˜åŠ¿**ï¼šæ‰©å±•æ”¯æŒæ›´å¤šæ ¼å¼  
**æŒ‘æˆ˜**ï¼šå¤æ‚åº¦å’Œèµ„æºæ¶ˆè€—æ˜¾è‘—å¢åŠ 

### æ–¹æ¡ˆ2ï¼šæ··åˆæ™ºèƒ½æ¨¡å¼ï¼ˆæ¨èï¼‰
```python
class SmartDownloadRouter:
    """æ™ºèƒ½ä¸‹è½½è·¯ç”±å™¨"""
    
    def route_download(self, format_info):
        if format_info.is_single_source:
            return OptimizedTempFileDownloader()  # å½“å‰ä¼˜åŒ–æ¨¡å¼
        elif format_info.is_small_merge:  # <100MB
            return LightweightMergeDownloader()   # è½»é‡çº§åˆå¹¶
        else:
            return TraditionalCeleryDownloader()  # ä¼ ç»Ÿåå°å¤„ç†
```

**ä¼˜åŠ¿**ï¼š
- ä¿æŒå•ä¸€æºçš„æ€§èƒ½ä¼˜åŠ¿
- ä¸ºå°æ–‡ä»¶åˆ†æµæä¾›ä¸­ç­‰ä¼˜åŒ–
- å¤§æ–‡ä»¶åˆ†æµç»§ç»­ä½¿ç”¨ç¨³å®šçš„åå°å¤„ç†

### æ–¹æ¡ˆ3ï¼šåå°æ¨¡å¼ä¼˜åŒ–
```python
# åœ¨Celeryä»»åŠ¡ä¸­ä¹Ÿæ·»åŠ å…ƒæ•°æ®åµŒå…¥
@celery_app.task
def enhanced_merge_download(video_url, video_format, audio_format):
    # ä¸‹è½½ + åˆå¹¶ + å…ƒæ•°æ®åµŒå…¥
    video_file = download_with_retry(video_url, video_format)
    audio_file = download_with_retry(video_url, audio_format)
    
    # FFmpeg with metadata
    merged_file = ffmpeg_merge(
        video_file, audio_file,
        metadata={"comment": f"Source: {create_simplified_identifier(video_url)}"}
    )
    
    return {"file_path": merged_file, "metadata": "embedded"}
```

## ğŸ“Š æ¨èç­–ç•¥

### å½“å‰æœ€ä½³å®è·µ
1. **ä¿æŒç°æœ‰ä¼˜åŒ–**ï¼šç»§ç»­ä¸“æ³¨å•ä¸€æºçš„æ€§èƒ½ä¼˜åŒ–
2. **æ™ºèƒ½è·¯ç”±**ï¼šé€šè¿‡`supports_browser_download`æ ‡å¿—è¿›è¡Œæ™ºèƒ½é€‰æ‹©
3. **ç”¨æˆ·æ•™è‚²**ï¼šåœ¨UIä¸­æ˜ç¡®æ ‡è¯†å“ªäº›æ ¼å¼æ”¯æŒå¿«é€Ÿä¸‹è½½

### æ¸è¿›å¼æ”¹è¿›è·¯å¾„
1. **Phase 1**ï¼šä¼˜åŒ–ç°æœ‰å•ä¸€æºæ¨¡å¼çš„ç¨³å®šæ€§å’Œæ€§èƒ½
2. **Phase 2**ï¼šä¸ºCeleryåå°ä»»åŠ¡æ·»åŠ å…ƒæ•°æ®åµŒå…¥æ”¯æŒ
3. **Phase 3**ï¼šæ¢ç´¢è½»é‡çº§åˆ†æµåˆå¹¶çš„å¯èƒ½æ€§

## ğŸ¯ ç»“è®º

### æŠ€æœ¯å†³ç­–æ€»ç»“
å½“å‰çš„**ä¸´æ—¶æ–‡ä»¶+å…ƒæ•°æ®åµŒå…¥ä¼˜åŒ–æ¨¡å¼ä¸“æ³¨äºå•ä¸€æº**æ˜¯æ­£ç¡®çš„æŠ€æœ¯å†³ç­–ï¼š

âœ… **ä¼˜åŠ¿æœ€å¤§åŒ–**ï¼šåœ¨é€‚ç”¨åœºæ™¯ä¸‹è·å¾—æ˜¾è‘—æ€§èƒ½æå‡  
âœ… **å¤æ‚åº¦å¯æ§**ï¼šé¿å…è¿‡åº¦å·¥ç¨‹åŒ–  
âœ… **ç”¨æˆ·ä»·å€¼æ˜ç¡®**ï¼šè§£å†³äº†å®é™…çš„ç”¨æˆ·ç—›ç‚¹  
âœ… **ç³»ç»Ÿç¨³å®šæ€§**ï¼šä¸å½±å“ç°æœ‰çš„åˆ†æµä¸‹è½½åŠŸèƒ½  

### é€‚ç”¨æ€§æŒ‡å—
- **æ¨èä½¿ç”¨ä¼˜åŒ–æ¨¡å¼**ï¼šX.comã€çŸ­è§†é¢‘å¹³å°ã€ç›´æ’­å¹³å°çš„complete streamæ ¼å¼
- **ç»§ç»­ä½¿ç”¨ä¼ ç»Ÿæ¨¡å¼**ï¼šYouTubeé«˜åˆ†è¾¨ç‡ã€éœ€è¦åˆå¹¶çš„ä¸“ä¸šå†…å®¹
- **æ™ºèƒ½é€‰æ‹©**ï¼šè®©ç³»ç»Ÿæ ¹æ®æ ¼å¼ç‰¹æ€§è‡ªåŠ¨é€‰æ‹©æœ€é€‚åˆçš„å¤„ç†æ–¹å¼

è¿™ç§åˆ†å±‚ä¼˜åŒ–ç­–ç•¥æ—¢ä¿è¯äº†æ€§èƒ½æå‡ï¼Œåˆç»´æŒäº†ç³»ç»Ÿçš„æ•´ä½“ç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

---

*æœ¬æ–‡æ¡£åˆ†æäº†ä¸‹è½½æ¨¡å¼çš„é€‚ç”¨æ€§è¾¹ç•Œï¼Œä¸ºæœªæ¥çš„æŠ€æœ¯é€‰æ‹©æä¾›äº†æ˜ç¡®çš„æŒ‡å¯¼åŸåˆ™ã€‚*  
*æœ€åæ›´æ–°ï¼š2025å¹´1æœˆ*
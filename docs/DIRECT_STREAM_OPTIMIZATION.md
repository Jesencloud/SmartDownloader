# “直流模式”下载优化总结报告

## 目标

本文档总结了为解决“直流模式”（即直接浏览器流式下载）中的一系列问题而进行的逐步优化。最终目标是实现一个稳定、可靠、用户体验良好的直接下载功能，同时确保服务器资源的整洁。

## 问题演进与解决方案

### 问题1：浏览器不显示下载进度

- **现象**：下载时，浏览器下载管理器始终显示“0B 即将开始下载”，直到下载完成。
- **根源**：服务器采用“先完整下载到临时文件，再发送给浏览器”的模式。浏览器没有收到`Content-Length`头，无法计算进度。
- **解决方案**：
    1.  将后端改造为真正的“流式代理”，让`yt-dlp`将数据流直接输出到标准输出（stdout）。
    2.  服务器实时读取`yt-dlp`的输出流，并立即转发给浏览器。
    3.  在HTTP响应头中加入从`yt-dlp`获取的预估`Content-Length`，使浏览器能够显示进度条。

### 问题2：下载无法完成，不停从头开始

- **现象**：文件下载到一定程度后，会从0%重新开始，无限循环。
- **根源**：浏览器为了支持断点续传，会发送带有`Range`请求头的分块下载请求。服务器没有正确处理这些请求，每次都从文件开头发送数据，导致浏览器不断重试。
- **解决方案**：
    1.  为服务器端点添加`Range`请求处理逻辑。
    2.  当收到`Range`请求时，返回`206 Partial Content`状态码，并设置正确的`Content-Range`和`Content-Length`（分块大小）响应头。
    3.  将请求的字节范围通过`yt-dlp`的`--download-section`参数传递给下载命令，只下载文件的特定部分。

### 问题3：服务器在下载完成后抛出 `Content-Length` 相关的异常

- **现象**：文件下载接近100%时，服务器崩溃并抛出`RuntimeError: Response content shorter than Content-Length`。
- **根源**：`yt-dlp`对流媒体提供的文件大小是**估算值**。当实际下载的字节数与响应头中承诺的`Content-Length`不完全相符时，ASGI服务器会认为这是一个严重错误并中断连接。
- **解决方案**：
    1.  改变策略，**只在处理精确的范围请求时才设置`Content-Length`**。
    2.  对于完整的、从头开始的下载，**不再发送`Content-Length`头**。这会使服务器自动切换到`Transfer-Encoding: chunked`模式，该模式专门用于传输大小未知的内容，从而完美解决了估算不准的问题。

### 问题4：下载大文件时，服务器因 `ValueError` 异常崩溃

- **现象**：下载较大的文件时，服务器崩溃并抛出`ValueError: Separator is not found, and chunk exceed the limit`。
- **根源**：用于调试的`log_stderr`函数使用`readline()`来读取`yt-dlp`的错误流。但`yt-dlp`的进度条输出不带换行符，当这一行数据超长时，超出了`readline()`的内部缓冲区限制，导致异常。
- **解决方案**：将`log_stderr`函数中的`await process.stderr.readline()`修改为`await process.stderr.read(1024)`，以块为单位读取数据，避免了`readline`的限制。

### 问题5：日志刷屏与临时文件残留

- **现象**：
    1.  服务器控制台被`yt-dlp`的进度条信息刷屏。
    2.  取消下载后，`--Frag*`等临时分片文件残留在项目根目录。
- **根源**：
    1.  `yt-dlp`默认会将进度信息输出到`stderr`。
    2.  `yt-dlp`默认在当前工作目录创建临时文件。
- **解决方案**：
    1.  在`yt-dlp`命令中添加`--no-progress`标志，禁止进度条输出。
    2.  在`config.yaml`中添加`downloader.temp_path`配置项。
    3.  实现**唯一的临时目录方案**：
        - 每次下载前，在配置的临时目录下创建一个唯一的子目录（UUID命名）。
        - 使用`--paths`参数将`yt-dlp`的所有临时文件定向到这个唯一子目录。
        - 在`finally`块中，无论下载成功、失败还是取消，都用`shutil.rmtree()`强制删除这个唯一子目录及其所有内容，实现**零文件残留**。

### 问题6：浏览器始终显示“正在恢复”

- **现象**：即便是全新的下载，浏览器也显示“正在恢复”，而非“正在下载”。
- **根源**：浏览器为了测试服务器能力，首次请求时常会发送`Range: bytes=0-`或`Range: bytes=0-1`这样的试探性请求。服务器错误地将其识别为断点续传请求，并返回了`206 Partial Content`状态码。
- **解决方案**：修正服务器逻辑，规定**只有当`Range`请求的起始字节大于0时**，才将其视为真正的断点续传并返回`206`。所有从字节0开始的请求，一律视为全新下载，返回`200 OK`。

## 最终实现

当前的“直流模式”是一个健壮、高效且用户友好的下载系统：
- **智能的请求处理**：能正确区分全新下载和断点续传，向浏览器返回正确的状态码。
- **可靠的流式传输**：对于大小不确定的文件，使用`Transfer-Encoding: chunked`确保下载的完整性。
- **彻底的资源清理**：通过为每次下载创建和销毁唯一的临时目录，实现了即时、无残留的垃圾回收。
- **可配置性**：临时文件的存储位置可以通过`config.yaml`灵活配置。

## 配置说明

在`config.yaml`的`downloader`部分，新增了以下配置项：

```yaml
downloader:
  # ... 其他配置
  temp_path: "/path/to/your/project/downloads/temp" # 下载流的临时文件目录
```

- **`temp_path`**: 用于指定“直流模式”下`yt-dlp`创建的临时分片文件存放的根目录。程序会在该目录下创建唯一的子目录用于每次下载，并在下载结束后自动清理。
